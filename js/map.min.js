"use strict";var componentconstructors={},maptypes={},map=null;function DynMap(e){var t=this;t.checkForSavedURL()||(t.options=e,$.getJSON(t.options.url.configuration,function(e){t.configure(e),t.initialize()},function(e,t){alert("Could not retrieve configuration: "+t)}))}componentconstructors.testcomponent=function(e,t){console.log("initialize"),$(e).bind("worldchanged",function(){console.log("worldchanged")}),$(e).bind("mapchanging",function(){console.log("mapchanging")}),$(e).bind("mapchanged",function(){console.log("mapchanged")}),$(e).bind("zoomchanged",function(){console.log("zoomchanged")}),$(e).bind("worldupdating",function(){console.log("worldupdating")}),$(e).bind("worldupdate",function(){console.log("worldupdate")}),$(e).bind("worldupdated",function(){console.log("worldupdated")}),$(e).bind("worldupdatefailed",function(){console.log("worldupdatefailed")}),$(e).bind("playeradded",function(){console.log("playeradded")}),$(e).bind("playerremoved",function(){console.log("playerremoved")}),$(e).bind("playerupdated",function(){console.log("playerupdated")})},DynMap.prototype={components:[],worlds:{},registeredTiles:[],lasttimestamp:(new Date).getUTCMilliseconds(),reqid:0,servertime:0,serverday:!1,inittime:(new Date).getTime(),followingPlayer:"",initfollow:null,missedupdates:0,maxcount:-1,sidebar:null,sidebarPanel:null,layercontrol:void 0,sidebarSections:[],nogui:!1,nocompass:!1,formatUrl:function(e,t){var o=this.options.url[e];return $.each(t,function(e,t){o=o.replace("{"+e+"}",t)}),o},configure:function(e){var t=this;$.extend(t.options,e),$.each(t.options.worlds,function(e,o){var a=t.worlds[o.name]=$.extend({},o,{maps:{}});$.each(o.maps,function(e,o){var n=$.extend({},o,{world:a,dynmap:t});n=a.maps[o.name]=maptypes[o.type](n),t.options.defaultmap&&t.options.defaultmap==o.name&&(a.defaultmap=n),a.defaultmap=a.defaultmap||n}),t.defaultworld=t.defaultworld||a});var o=t.getParameterByName("worldname");""==o&&(o=t.options.defaultworld||""),""!=o&&(t.defaultworld=t.worlds[o]||t.defaultworld),""!=(o=t.getParameterByName("mapname"))&&(t.defaultworld.defaultmap=t.defaultworld.maps[o]||t.defaultworld.defaultmap),null!=(o=t.getIntParameterByName("x"))&&(t.defaultworld.center.x=o),null!=(o=t.getIntParameterByName("y"))&&(t.defaultworld.center.y=o),null!=(o=t.getIntParameterByName("z"))&&(t.defaultworld.center.z=o),""!=(o=t.getParameterByName("nogui"))&&(t.nogui="true"==o),""!=(o=t.getParameterByName("nocompass"))&&(t.nocompass="true"==o)},initialize:function(){var e,t=this,o=$(t.options.container);o.addClass("dynmap"),(e=$("<div/>")).addClass("map").appendTo(o),t.options.title&&(document.title=t.options.title);var a=t.getIntParameterByName("zoom");null!=a&&(t.options.defaultzoom=a);var n=t.getParameterByName("showlayercontrol");""!=n&&(t.options.showlayercontrol=n),void 0===t.options.defaultzoom&&(t.options.defaultzoom=1);var r=t.getParameterByName("playername");""!=r&&(t.initfollow=r);var i=t.getParameterByName("sidebaropened");"false"!=i&&"true"!=i&&"pinned"!=i||(t.options.sidebaropened=i);var s,l,p=this.map=new L.Map(e.get(0),{zoom:t.options.defaultzoom,center:new L.LatLng(0,0),zoomAnimation:!0,zoomControl:!t.nogui,attributionControl:!1,crs:L.extend({},L.CRS,{code:"simple",projection:{project:function(e){return new L.Point(e.lat,e.lng)},unproject:function(e){return new L.LatLng(e.x,e.y)}},transformation:new L.Transformation(1,0,1,0),scale:function(e){return 1<<e}}),continuousWorld:!0,worldCopyJump:!1});window.map=p,p.on("zoomend",function(){t.maptype.updateTileSize(t.map.getZoom()),$(t).trigger("zoomchanged")});var d="true"==t.getParameterByName("nopanel")||t.nogui,m="pinned";"false"==t.options.sidebaropened&&(m=""),l=t.sidebar=$("<div/>").addClass("sidebar "+m),s=t.sidebarPanel=$("<div/>").addClass("panel").appendTo(l),"true"!=t.options.sidebaropened&&$("<div/>").addClass("pin").click(function(){l.toggleClass("pinned")}).appendTo(s),d||l.appendTo(o);var c=SidebarUtils.createListSection(t.options["msg-maptypes"]);t.worldlist=c.content.addClass("worldlist"),c.section.appendTo(s),t.sidebarSections.push(c);var u={},f={};function g(){t.updateSidebarHeight()}if($.each(t.worlds,function(e,t){var o;t.element=$("<li/>").addClass("world subsection").text(t.title).append(o=$("<ul/>").addClass("maplist sublist")).data("world",t),u[t.name]=o}),$.each(t.worlds,function(e,o){var a=u[o.name];$.each(o.maps,function(e,n){var r=o.name;n.options.append_to_world&&(r=n.options.append_to_world);var i=u[r];i||(i=a,r=o.name),f[r]||(f[r]=!0);var s=r,l=e;s.endsWith("_nether")||"DIM-1"==s?(s="nether",l="nether"==e?"surface":"flat"):s.endsWith("the_end")||"DIM1"==s?(s="the_end",l="the_end"==e?"surface":"flat"):(s="world",l=["surface","flat","biome","cave"].includes(e)?e:"flat"),n.element=$("<li/>").addClass("map item").append($("<a/>").attr({title:n.options.title,href:"#"}).addClass("maptype").css({backgroundImage:"url("+(n.options.icon||"images/block_"+s+"_"+l+".png")+")"}).text(n.options.title)).click(function(){t.selectMap(n)}).data("map",n).appendTo(i)})}),$.each(t.worlds,function(e,o){f[o.name]&&o.element.appendTo(t.worldlist)}),$(window).resize(g),g(),!t.nogui&&!t.nocompass){var y=$("<div/>").addClass("compass");L.Browser.mobile&&y.addClass("mobilecompass"),y.appendTo(o)}if("true"!=t.options.sidebaropened)$("<div/>").addClass("hitbar").click(function(){l.toggleClass("pinned")}).appendTo(s);t.alertbox=$("<div/>").addClass("alertbox").hide().appendTo(o);t.selectMap(t.defaultworld.defaultmap);var h=0,w={};t.nogui||$.each(t.options.components,function(e,t){w[t.type]||(w[t.type]=[],h++),w[t.type].push(t)});var v={};$.each(w,function(e,o){v[e]=!0,loadjs("js/"+e+".js",function(){var a=componentconstructors[e];a&&$.each(o,function(e,o){t.components.push(new a(t,o))}),delete v[e],0==--h&&(t.update(),setTimeout(function(){t.update()},t.options.updaterate))})}),t.nogui?setTimeout(function(){t.update()},t.options.updaterate):setTimeout(function(){$.each(w,function(e,o){v[e]&&t.alertbox.text("Error loading js/"+e+".js").show()}),h>0&&setTimeout(function(){t.update()},t.options.updaterate)},15e3)},updateSidebarHeight:function(){var e=this,t=0,o=0,a=0,n=0,r=[];$.each(e.sidebarSections,function(e,i){var s=i.legend.outerHeight(!0),l=i.content.scrollHeight(),p=i.upBtn.outerHeight(!0),d=i.downBtn.outerHeight(!0),m=i.section.outerHeight(!0)-i.section.height(),c=s+l+m;o+=c,t+=s+m,a+=c,l<p+d+24?(r.push(e),t+=l):(n+=l,a+=p+d,t+=p+d+24)});var i=e.sidebar.height();if(o>i&&i>t){var s=a-i;$.each(e.sidebarSections,function(e,t){if($.inArray(e,r)>-1)return t.upBtn.hide(),t.downBtn.hide(),void t.content.height("auto");t.upBtn.show(),t.downBtn.show();var o=t.content.scrollHeight(),a=s*(o/n);t.content.height(o-a)})}else $.each(e.sidebarSections,function(e,t){t.upBtn.hide(),t.downBtn.hide(),t.content.height("auto")});i<t?e.sidebar.css({"overflow-y":"scroll","overflow-x":"hidden"}):e.sidebar.css({"overflow-y":"","overflow-x":""})},getProjection:function(){return this.maptype.getProjection()},selectMapAndPan:function(e,t,o){if(!e)throw"Cannot select map "+e;var a=this;if(a.maptype!==e){$(a).trigger("mapchanging");var n=e.options.world,r=$(".compass");a.maptype&&r.removeClass("compass_"+a.maptype.options.compassview).removeClass("compass_"+a.maptype.options.name),r.addClass("compass_"+e.options.compassview).addClass("compass_"+e.options.name);var i=a.world!==e.options.world,s=(a.maptype&&a.maptype.getProjection())!==(e&&e.projection),l=a.map.getZoom();i&&(a.registeredTiles=[],a.inittime=(new Date).getTime()),i&&a.world&&(a.world.lastcenter=a.maptype.getProjection().fromLatLngToLocation(a.map.getCenter(),64)),a.maptype&&a.map.removeLayer(a.maptype);var p=a.maptype;if(a.world=n,a.maptype=e,a.maptype.options.maxZoom<l&&(l=a.maptype.options.maxZoom),a.map.options.maxZoom=a.maptype.options.maxZoom,a.map.options.minZoom=a.maptype.options.minZoom,s||i||t){var d;if(t)d=a.getProjection().fromLocationToLatLng(t);else if(i){var m;m=n.lastcenter?n.lastcenter:$.extend({x:0,y:64,z:0},n.center),d=a.getProjection().fromLocationToLatLng(m)}else{var c=null;null!=p&&(c=p.getProjection().fromLatLngToLocation(a.map.getCenter(),64)),d=null!=c?a.getProjection().fromLocationToLatLng(c):a.map.getCenter()}a.map.setView(d,l,!0)}else a.map.setZoom(l);a.map.addLayer(a.maptype),i&&$(a).trigger("worldchanged"),$(a).trigger("mapchanged"),$(".map",a.worldlist).removeClass("selected"),$(e.element).addClass("selected"),a.updateBackground(),o&&o()}},selectMap:function(e,t){this.selectMapAndPan(e,null,t)},selectWorldAndPan:function(e,t,o){var a=this;if("String"==typeof e&&(e=a.worlds[e]),a.world!==e)a.selectMapAndPan(e.defaultmap,t,o);else if(t){var n=a.maptype.getProjection().fromLocationToLatLng(t);a.panToLatLng(n,o)}else o&&o()},selectWorld:function(e,t){this.selectWorldAndPan(e,null,t)},panToLocation:function(e,t){if(e.world)this.selectWorldAndPan(e.world,e,function(){t&&t()});else{var o=this.maptype.getProjection().fromLocationToLatLng(e);this.panToLatLng(o,t)}},panToLayerPoint:function(e,t){var o=this.map.layerPointToLatLng(e);this.map.panToLatLng(o),t&&t()},panToLatLng:function(e,t){this.map.panTo(e),t&&t()},update:function(){var e=this;$(e).trigger("worldupdating"),$.getJSON(e.formatUrl("update",{world:e.world.name,timestamp:e.lasttimestamp,reqid:e.reqid}),function(t){if(e.reqid++,t)if(e.alertbox.hide(),t.error)alert(t.error);else if(e.lasttimestamp!=t.timestamp){e.options.jsonfile||(e.lasttimestamp=t.timestamp),e.servertime=t.servertime;var o=e.servertime>23100||e.servertime<12900;e.serverday!=o&&(e.serverday=o,e.updateBackground(),e.maptype.options.nightandday&&(e.map.removeLayer(e.maptype),e.map.addLayer(e.maptype))),$.each(t.updates,function(t,o){(!e.options.jsonfile||e.lasttimestamp<=o.timestamp)&&($(e).trigger("worldupdate",[o]),swtch(o.type,{tile:function(){e.onTileUpdated(o.name,o.timestamp)},component:function(){$(e).trigger("component."+o.ctype,[o])}}))}),$(e).trigger("worldupdated",[t]),e.lasttimestamp=t.timestamp,e.missedupdates=0,setTimeout(function(){e.update()},e.options.updaterate)}else setTimeout(function(){e.update()},e.options.updaterate);else setTimeout(function(){e.update()},e.options.updaterate)},function(t,o,a){e.lasttimestamp--,e.missedupdates++,e.missedupdates>2&&(e.alertbox.text("Could not update map: "+(o||"Could not connect to server")).show(),$(e).trigger("worldupdatefailed")),setTimeout(function(){e.update()},e.options.updaterate)})},getTileUrl:function(e,t){var o=this.registeredTiles[e];if(null==o){var a=this.options.url.tiles;o=this.registeredTiles[e]=a+escape(this.world.name+"/"+e)}return o},onTileUpdated:function(e,t){this.registeredTiles[e];this.registeredTiles[e]=url+this.world.name+"/"+e,this.maptype.updateNamedTile(e)},updateBackground:function(){var e=this,t="#000000";e.serverday?e.maptype.options.backgroundday?t=e.maptype.options.backgroundday:e.maptype.options.background&&(t=e.maptype.options.background):e.maptype.options.backgroundnight?t=e.maptype.options.backgroundnight:e.maptype.options.background&&(t=e.maptype.options.background),$(".map").css("background",t),$(".leaflet-tile").css("background",t)},getParameterByName:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(window.location.href);return null==t?"":decodeURIComponent(t[1].replace(/\+/g," "))},getIntParameterByName:function(e){var t=this.getParameterByName(e);return""!=t&&NaN!=(t=parseInt(t,10))?t:null},getBoolParameterByName:function(e){var t=this.getParameterByName(e);if(""!=t){if("true"==t)return!0;if("false"==t)return!1}return null},layersetlist:[],addToLayerSelector:function(e,t,o){var a,n=this;for("false"==n.options.showlayercontrol||n.layercontrol||(n.layercontrol=new DynmapLayerControl,"pinned"==n.options.showlayercontrol&&(n.layercontrol.options.collapsed=!1),map.addControl(n.layercontrol)),a=0;a<n.layersetlist.length;a++)if(n.layersetlist[a].layer===e){n.layersetlist[a].priority=o,n.layersetlist[a].name=t;break}if(a>=n.layersetlist.length&&(n.layersetlist[a]={layer:e,priority:o,name:t}),n.layersetlist.sort(function(e,t){return e.priority!=t.priority?e.priority-t.priority:e.name<t.name?-1:e.name>t.name?1:0}),"false"!=n.options.showlayercontrol){for(a=0;a<n.layersetlist.length;a++)n.layercontrol.removeLayer(n.layersetlist[a].layer);for(a=0;a<n.layersetlist.length;a++)n.layercontrol.addOverlay(n.layersetlist[a].layer,n.layersetlist[a].name,a)}},removeFromLayerSelector:function(e){var t,o=this;for(t=0;t<o.layersetlist.length;t++)if(o.layersetlist[t].layer===e){o.layersetlist.splice(t,1),"false"!=o.options.showlayercontrol&&o.layercontrol.removeLayer(e);break}},getLink:function(){var e=this,t=window.location.pathname,o=e.maptype.getProjection().fromLatLngToLocation(e.map.getCenter(),64);return t=e.options["round-coordinates"]?t+"?worldname="+e.world.name+"&mapname="+e.maptype.options.name+"&zoom="+e.map.getZoom()+"&x="+o.x+"&y="+o.y+"&z="+o.z:t+"?worldname="+e.world.name+"&mapname="+e.maptype.options.name+"&zoom="+e.map.getZoom()+"&x="+Math.round(o.x)+"&y="+Math.round(o.y)+"&z="+Math.round(o.z)},saveURL:function(){window.location.href.indexOf("?")>0&&(document.cookie="dynmapurl="+escape(window.location))},checkForSavedURL:function(){var e,t,o,a=document.cookie.split(";");for(e=0;e<a.length;e++)if(t=a[e].substr(0,a[e].indexOf("=")),o=a[e].substr(a[e].indexOf("=")+1),"dynmapurl"==(t=t.replace(/^\s+|\s+$/g,""))){var n=unescape(o);if(document.cookie="dynmapurl=; expires=Thu, 01-Jan-70 00:00:01 GMT;",n.indexOf("?")>=0&&n!=window.location)return window.location=n,!0}return!1}};