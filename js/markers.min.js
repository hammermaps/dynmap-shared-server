var dynmapmarkersets={};componentconstructors.markers=function(e,a){function r(r){$.each(dynmapmarkersets,function(e,a){$.each(a.markers,function(e,r){m(a,r)}),a.markers={},$.each(a.areas,function(e,r){m(a,r)}),a.areas={},$.each(a.lines,function(e,r){m(a,r)}),a.lines={},$.each(a.circles,function(e,r){m(a,r)}),a.circles={}});var l=concatURL(e.options.url.markers,"_markers_/marker_"+r+".json");$.getJSON(l,function(r){var l=r.timestamp;$.each(r.sets,function(r,t){null==t.showlabels&&(t.showlabels=a.showlabel);var m=dynmapmarkersets[r];m?(m.label!=t.label&&(m.label=t.label,e.addToLayerSelector(m.layergroup,m.label,m.layerprio||0)),m.markers={},m.areas={},m.lines={},m.circles={},m.hide=t.hide,m.showlabels=t.showlabels,m.timestamp=l):n(m={id:r,label:t.label,hide:t.hide,layerprio:t.layerprio,minzoom:t.minzoom||-1,maxzoom:t.maxzoom||-1,showlabels:t.showlabels,markers:{},areas:{},lines:{},circles:{}},l),dynmapmarkersets[r]=m,$.each(t.markers,function(e,a){m.markers[e]={label:a.label,markup:a.markup,x:a.x,y:a.y,z:a.z,icon:a.icon,desc:a.desc,dim:a.dim,minzoom:a.minzoom||-1,maxzoom:a.maxzoom||-1},o(m,m.markers[e],l)}),$.each(t.areas,function(e,a){m.areas[e]={label:a.label,markup:a.markup,desc:a.desc,x:a.x,z:a.z,ytop:a.ytop,ybottom:a.ybottom,color:a.color,weight:a.weight,opacity:a.opacity,fillcolor:a.fillcolor,fillopacity:a.fillopacity,minzoom:a.minzoom||-1,maxzoom:a.maxzoom||-1},i(m,m.areas[e],l)}),$.each(t.lines,function(e,a){m.lines[e]={label:a.label,markup:a.markup,desc:a.desc,x:a.x,y:a.y,z:a.z,color:a.color,weight:a.weight,opacity:a.opacity,minzoom:a.minzoom||-1,maxzoom:a.maxzoom||-1},s(m,m.lines[e],l)}),$.each(t.circles,function(e,a){m.circles[e]={label:a.label,markup:a.markup,desc:a.desc,x:a.x,y:a.y,z:a.z,xr:a.xr,zr:a.zr,color:a.color,weight:a.weight,opacity:a.opacity,fillcolor:a.fillcolor,fillopacity:a.fillopacity,minzoom:a.minzoom||-1,maxzoom:a.maxzoom||-1},c(m,m.circles[e],l)})}),$(e).trigger("markersupdated",[dynmapmarkersets])})}function l(a){return e.getProjection().fromLocationToLatLng({x:a.x,y:a.y,z:a.z})}function o(a,r,o){r.our_layer&&(a.layergroup.removeLayer(r.our_layer),delete r.our_layer,r.our_layer=null);var m=l(r);if(r.our_layer=new L.CustomMarker(m,{elementCreator:function(){var o=document.createElement("div"),t=l(r);r.our_layer.setLatLng(t);var m=concatURL(e.options.url.markers,"_markers_/"+r.icon+".png");return $(o).addClass("Marker").addClass("mapMarker").append($("<img/>").addClass("markerIcon"+r.dim).attr({src:m})),r.markup?$(o).append($("<span/>").addClass(a.showlabels?"markerName-show":"markerName").addClass("markerName_"+a.id).addClass("markerName"+r.dim).append(r.label)):""!=r.label&&$(o).append($("<span/>").addClass(a.showlabels?"markerName-show":"markerName").addClass("markerName_"+a.id).addClass("markerName"+r.dim).text(r.label)),o}}),r.timestamp=o,r.desc){var n=document.createElement("div");$(n).addClass("MarkerPopup").append(r.desc),r.our_layer.bindPopup(n,{})}t(a,r,e.map.getZoom())}function t(e,a,r){if(e&&a&&a.our_layer){var l=a.minzoom>=0?a.minzoom:e.minzoom,o=a.maxzoom>=0?a.maxzoom:e.maxzoom;o<0&&(o=100),e.layergroup.removeLayer(a.our_layer),r>=l&&r<=o&&e.layergroup.addLayer(a.our_layer)}}function m(e,a){a&&a.our_layer&&(e.layergroup.removeLayer(a.our_layer),delete a.our_layer)}function n(a,r){a.layergroup=new L.LayerGroup,a.timestamp=r,a.hide||e.map.addLayer(a.layergroup),e.addToLayerSelector(a.layergroup,a.label,a.layerprio||0)}function i(a,r,l){var o={color:r.color,opacity:r.opacity,weight:r.weight,fillOpacity:r.fillopacity,fillColor:r.fillcolor,smoothFactor:0};if(r.our_layer&&(a.layergroup.removeLayer(r.our_layer),delete r.our_layer,r.our_layer=null),2==r.x.length?r.ytop==r.ybottom?r.our_layer=function(e,a,r,l,o,t,m){return m.fillOpacity<=0?new L.Polyline([latlng(a,l,t),latlng(e,l,t),latlng(e,l,o),latlng(a,l,o),latlng(a,l,t)],m):new L.Polygon([latlng(a,l,t),latlng(e,l,t),latlng(e,l,o),latlng(a,l,o)],m)}(r.x[0],r.x[1],r.ytop,r.ybottom,r.z[0],r.z[1],o):r.our_layer=function(e,a,r,l,o,t,m){return new L.MultiPolygon([[latlng(a,l,t),latlng(e,l,t),latlng(e,l,o),latlng(a,l,o)],[latlng(a,r,t),latlng(e,r,t),latlng(e,r,o),latlng(a,r,o)],[latlng(a,l,t),latlng(a,r,t),latlng(e,r,t),latlng(e,l,t)],[latlng(e,l,t),latlng(e,r,t),latlng(e,r,o),latlng(e,l,o)],[latlng(a,l,o),latlng(a,r,o),latlng(e,r,o),latlng(e,l,o)],[latlng(a,l,t),latlng(a,r,t),latlng(a,r,o),latlng(a,l,o)]],m)}(r.x[0],r.x[1],r.ytop,r.ybottom,r.z[0],r.z[1],o):r.ytop==r.ybottom?r.our_layer=d(r.x,r.ytop,r.ybottom,r.z,o):r.our_layer=function(e,a,r,l,o){var t,m=[],n=[],i=[];for(t=0;t<e.length;t++)m[t]=latlng(e[t],a,l[t]),n[t]=latlng(e[t],r,l[t]);for(t=0;t<e.length;t++){var s=[];s[0]=m[t],s[1]=n[t],s[2]=n[(t+1)%e.length],s[3]=m[(t+1)%e.length],i[t]=s}return i[e.length]=n,i[e.length+1]=m,new L.MultiPolygon(i,o)}(r.x,r.ytop,r.ybottom,r.z,o),r.timestamp=l,""!=r.label){var m=document.createElement("span");r.desc?$(m).addClass("AreaPopup").append(r.desc):r.markup?$(m).addClass("AreaPopup").append(r.label):$(m).text(r.label),r.our_layer.bindPopup($(m).html(),{})}t(a,r,e.map.getZoom())}function s(a,r,l){var o={color:r.color,opacity:r.opacity,weight:r.weight,smoothFactor:0};r.our_layer&&(a.layergroup.removeLayer(r.our_layer),delete r.our_layer,r.our_layer=null);var m,n=[];for(m=0;m<r.x.length;m++)n[m]=latlng(r.x[m],r.y[m],r.z[m]);if(r.our_layer=new L.Polyline(n,o),r.timestamp=l,""!=r.label){var i=document.createElement("span");r.desc?$(i).addClass("LinePopup").append(r.desc):r.markup?$(i).addClass("LinePopup").append(r.label):$(i).text(r.label),r.our_layer.bindPopup($(i).html(),{})}t(a,r,e.map.getZoom())}function c(a,r,l){var o={color:r.color,opacity:r.opacity,weight:r.weight,fillOpacity:r.fillopacity,fillColor:r.fillcolor};r.our_layer&&(a.layergroup.removeLayer(r.our_layer),delete r.our_layer,r.our_layer=null);var m,n=[],i=[];for(m=0;m<360;m++){var s=m*Math.PI/180;n[m]=r.xr*Math.sin(s)+r.x,i[m]=r.zr*Math.cos(s)+r.z}if(r.our_layer=d(n,r.y,r.y,i,o),r.timestamp=l,""!=r.label){var c=document.createElement("span");r.desc?$(c).addClass("CirclePopup").append(r.desc):r.markup?$(c).addClass("CirclePopup").append(r.label):$(c).text(r.label),r.our_layer.bindPopup($(c).html(),{})}t(a,r,e.map.getZoom())}function d(e,a,r,l,o){var t,m=[];for(t=0;t<e.length;t++)m[t]=latlng(e[t],r,l[t]);return o.fillOpacity<=0?(m.push(m[0]),new L.Polyline(m,o)):new L.Polygon(m,o)}latlng=function(a,r,l){return e.getProjection().fromLocationToLatLng(new Location(void 0,a,r,l))},$(e).bind("component.markers",function(r,l){if("markerupdated"==l.msg){if(!(u=dynmapmarkersets[l.set]))return;m(u,u.markers[l.id]);var t={x:l.x,y:l.y,z:l.z,icon:l.icon,label:l.label,markup:l.markup,desc:l.desc,dim:l.dim||"16x16",minzoom:l.minzoom||-1,maxzoom:l.maxzoom};u.markers[l.id]=t,o(u,t,l.timestamp)}else if("markerdeleted"==l.msg){if(!(u=dynmapmarkersets[l.set]))return;m(u,u.markers[l.id]),delete u.markers[l.id]}else if("setupdated"==l.msg)null==l.showlabels&&(l.showlabels=a.showlabel),dynmapmarkersets[l.id]?(dynmapmarkersets[l.id].label==l.label&&dynmapmarkersets[l.id].layerprio==l.layerprio&&dynmapmarkersets[l.id].showlabels==l.showlabels||(dynmapmarkersets[l.id].label=l.label,dynmapmarkersets[l.id].layerprio=l.layerprio,dynmapmarkersets[l.id].showlabels=l.showlabels,e.addToLayerSelector(dynmapmarkersets[l.id].layergroup,dynmapmarkersets[l.id].label,dynmapmarkersets[l.id].layerprio||0)),dynmapmarkersets[l.id].minzoom!=l.minzoom&&(dynmapmarkersets[l.id].minzoom=l.minzoom),dynmapmarkersets[l.id].maxzoom!=l.maxzoom&&(dynmapmarkersets[l.id].maxzoom=l.maxzoom)):(dynmapmarkersets[l.id]={id:l.id,label:l.label,layerprio:l.layerprio,minzoom:l.minzoom,maxzoom:l.maxzoom,showlabels:l.showlabels,markers:{}},n(dynmapmarkersets[l.id]));else if("setdeleted"==l.msg)dynmapmarkersets[l.id]&&(e.removeFromLayerSelector(dynmapmarkersets[l.id].layergroup),delete dynmapmarkersets[l.id].layergroup,delete dynmapmarkersets[l.id]);else if("areaupdated"==l.msg){if(!(u=dynmapmarkersets[l.set]))return;m(u,u.areas[l.id]);var d={x:l.x,ytop:l.ytop,ybottom:l.ybottom,z:l.z,label:l.label,markup:l.markup,desc:l.desc,color:l.color,weight:l.weight,opacity:l.opacity,fillcolor:l.fillcolor,fillopacity:l.fillopacity,minzoom:l.minzoom||-1,maxzoom:l.maxzoom||-1};u.areas[l.id]=d,i(u,d,l.timestamp)}else if("areadeleted"==l.msg){if(!(u=dynmapmarkersets[l.set]))return;m(u,u.areas[l.id]),delete u.areas[l.id]}else if("lineupdated"==l.msg){if(!(u=dynmapmarkersets[l.set]))return;m(u,u.lines[l.id]);var p={x:l.x,y:l.y,z:l.z,label:l.label,markup:l.markup,desc:l.desc,color:l.color,weight:l.weight,opacity:l.opacity,minzoom:l.minzoom||-1,maxzoom:l.maxzoom||-1};u.lines[l.id]=p,s(u,p,l.timestamp)}else if("linedeleted"==l.msg){if(!(u=dynmapmarkersets[l.set]))return;m(u,u.lines[l.id]),delete u.lines[l.id]}else if("circleupdated"==l.msg){if(!(u=dynmapmarkersets[l.set]))return;m(u,u.circles[l.id]);var y={x:l.x,y:l.y,z:l.z,xr:l.xr,zr:l.zr,label:l.label,markup:l.markup,desc:l.desc,color:l.color,weight:l.weight,opacity:l.opacity,fillcolor:l.fillcolor,fillopacity:l.fillopacity,minzoom:l.minzoom||-1,maxzoom:l.maxzoom||-1};u.circles[l.id]=y,c(u,y,l.timestamp)}else if("circledeleted"==l.msg){var u;if(!(u=dynmapmarkersets[l.set]))return;m(u,u.circles[l.id]),delete u.circles[l.id]}$(e).trigger("markersupdated",[dynmapmarkersets])}),$(e).bind("mapchanging",function(e){$.each(dynmapmarkersets,function(e,a){$.each(a.markers,function(e,r){m(a,r)}),$.each(a.areas,function(e,r){m(a,r)}),$.each(a.lines,function(e,r){m(a,r)}),$.each(a.circles,function(e,r){m(a,r)})})}),$(e).bind("mapchanged",function(a){e.map.getZoom();$.each(dynmapmarkersets,function(e,a){$.each(a.markers,function(e,r){o(a,r,r.timestamp)}),$.each(a.areas,function(e,r){i(a,r,r.timestamp)}),$.each(a.lines,function(e,r){s(a,r,r.timestamp)}),$.each(a.circles,function(e,r){c(a,r,r.timestamp)})})}),$(e).bind("zoomchanged",function(a){var r=e.map.getZoom();$.each(dynmapmarkersets,function(e,a){$.each(a.markers,function(e,l){t(a,l,r)}),$.each(a.areas,function(e,l){t(a,l,r)}),$.each(a.lines,function(e,l){t(a,l,r)}),$.each(a.circles,function(e,l){t(a,l,r)})})}),$(e).bind("worldchanged",function(e){r(this.world.name)}),r(e.world.name)};